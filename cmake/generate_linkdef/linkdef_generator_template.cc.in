#define BDM_CREATE_LINKDEF

#include <fstream>
#include <string>
#include "linkdef_util.h"

// include all headers of this target
@linkdef_generator_includes@

namespace bdm {

static int main_add_to_linkdef = AddToLinkDefFunction([](std::set<LinkDefDescriptor>& entries){
  AddAllLinkDefEntries<BaseBiologyModule>(entries, true);
  AddAllLinkDefEntries<RuntimeVariables>(entries, true);
  AddAllLinkDefEntries<IntegralTypeWrapper<size_t>>(entries, true);
  AddAllLinkDefEntries<ResourceManager<>>(entries, true);
});

}  // namespace bdm

using bdm::LinkDefDescriptor;

const char* linkdef_header = R"LINKDEF_HEADER(// some C++ header definition
  #ifdef __ROOTCLING__
  // turns off dictionary generation for all
  #pragma link off all class;
  #pragma link off all function;
  #pragma link off all global;
  #pragma link off all typedef;

)LINKDEF_HEADER";

const char* linkdef_footer = "#endif";

int main() {
  std::set<LinkDefDescriptor> entries;

  for(auto&& function : bdm::kAddToLinkDefFunctions) {
    function(entries);
  }

  std::vector<std::string> linkdef_lines;
  for(auto&& ld_entry : entries) {
    ld_entry.GenerateLinkDefLine(linkdef_lines);
  }

  std::sort(linkdef_lines.begin(), linkdef_lines.end());

  std::ofstream ofs("@linkdef_file@");
  ofs << linkdef_header << std::endl;

  for (auto&& line : linkdef_lines) {
    ofs << "  " << line << std::endl;
  }

  ofs << std::endl <<  linkdef_footer << std::endl;
  ofs.close();
}
